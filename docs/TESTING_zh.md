# ğŸ§ª GitVersion.cmake æµ‹è¯•æ¡†æ¶

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº† GitVersion.cmake é¡¹ç›®çš„æµ‹è¯•æ¡†æ¶æ¶æ„ã€æ‰§è¡Œæ–¹æ³•å’Œæœ€ä½³å®è·µã€‚è¯¥æµ‹è¯•æ¡†æ¶æ—¨åœ¨ç¡®ä¿æ¨¡å—åœ¨å„ç§ç¯å¢ƒå’Œç”¨ä¾‹ä¸‹éƒ½èƒ½å¯é è¿è¡Œã€‚

## ğŸ› ï¸ æµ‹è¯•ç¯å¢ƒè®¾ç½®

åœ¨å¼€å§‹è¿è¡Œæµ‹è¯•ä¹‹å‰ï¼Œéœ€è¦ç¡®ä¿æ‚¨çš„ç¯å¢ƒé…ç½®æ­£ç¡®å¹¶å·²å®‰è£…æ‰€æœ‰ä¾èµ–é¡¹ã€‚

### ğŸ“¦ ä¾èµ–å®‰è£…

æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤è½»æ¾å®‰è£…æ‰€æœ‰å¿…è¦çš„æµ‹è¯•ä¾èµ–ï¼š

```bash
python run_tests.py --check-deps --install-deps
```

ç³»ç»Ÿå°†è‡ªåŠ¨æ£€æŸ¥ä¾èµ–é¡¹çŠ¶æ€å¹¶å®‰è£…ç¼ºå¤±çš„åŒ…ã€‚è¯¥å‘½ä»¤ä½¿ç”¨é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ `requirements-dev.txt` æ–‡ä»¶è¿›è¡Œä¾èµ–ç®¡ç†ï¼Œç¡®ä¿æµ‹è¯•ç¯å¢ƒçš„ä¸€è‡´æ€§å’Œå¯é‡ç°æ€§ã€‚

## ğŸ—ï¸ æµ‹è¯•æ¶æ„

æˆ‘ä»¬çš„æµ‹è¯•æ¡†æ¶é‡‡ç”¨åˆ†å±‚æ¶æ„ï¼ŒæŒ‰åŠŸèƒ½å¤æ‚åº¦å’Œä½¿ç”¨åœºæ™¯ç»„ç»‡æµ‹è¯•ç”¨ä¾‹ï¼Œç¡®ä¿å…¨é¢è¦†ç›–æ‰€æœ‰åŠŸèƒ½ç‚¹ã€‚

### ğŸ“ ç›®å½•ç»“æ„

æµ‹è¯•æ¡†æ¶æŒ‰ä»¥ä¸‹å±‚æ¬¡ç»“æ„ç»„ç»‡ï¼š

- `tests/`: æµ‹è¯•æ¡†æ¶çš„å…¥å£ç›®å½•
  - `utils/`: æ ¸å¿ƒæµ‹è¯•å·¥å…·å’Œè¾…åŠ©å‡½æ•°
  - `basic/`: åŸºç¡€åŠŸèƒ½æµ‹è¯•é›†
  - `advanced/`: é«˜çº§åŠŸèƒ½æµ‹è¯•é›†
  - `edge_cases/`: è¾¹ç¼˜æƒ…å†µå’Œç‰¹æ®Šåœºæ™¯æµ‹è¯•

## â–¶ï¸ è¿è¡Œæµ‹è¯•

GitVersion.cmake æä¾›äº†çµæ´»ä¾¿æ·çš„æµ‹è¯•æ‰§è¡Œæ–¹å¼ï¼Œé€‚åº”ä¸åŒçš„å¼€å‘å’Œè°ƒè¯•éœ€æ±‚ã€‚

### ğŸš€ ä½¿ç”¨æµ‹è¯•è¿è¡Œå™¨

æ‚¨å¯ä»¥ä½¿ç”¨é¡¹ç›®æ ¹ç›®å½•çš„ `run_tests.py` è„šæœ¬æ‰§è¡Œæµ‹è¯•ï¼Œè¯¥è„šæœ¬æä¾›å¤šç§é€‰é¡¹ï¼š

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
python run_tests.py

# è¿è¡Œæµ‹è¯•å¹¶æ˜¾ç¤ºè¯¦ç»†è¾“å‡ºï¼ˆåŒ…æ‹¬æµ‹è¯•æ‰§è¡Œè¿‡ç¨‹å’Œè¦†ç›–ç‡ä¿¡æ¯ï¼‰
python run_tests.py --verbose

# æ£€æŸ¥æµ‹è¯•ç¯å¢ƒä¾èµ–æ˜¯å¦å®Œæ•´
python run_tests.py --check-deps

# å®‰è£…æ‰€æœ‰å¼€å‘å’Œæµ‹è¯•ä¾èµ–é¡¹
python run_tests.py --install-deps

# ä»…è¿è¡Œç‰¹å®šæ ‡è®°çš„æµ‹è¯•ç»„
python run_tests.py --markers basic

# æŸ¥çœ‹æ‰€æœ‰å¯ç”¨çš„æµ‹è¯•æ ‡è®°åŠå…¶æè¿°
python run_tests.py --list-markers

# è¿è¡Œç‰¹å®šçš„æµ‹è¯•æ–‡ä»¶æˆ–æµ‹è¯•ç›®å½•
python run_tests.py tests/basic/version_tag_test.py
```

### ğŸš„ å¹¶è¡Œæµ‹è¯•æ‰§è¡Œ

ä¸ºæé«˜æµ‹è¯•æ‰§è¡Œæ€§èƒ½ï¼Œæµ‹è¯•æ¡†æ¶æ”¯æŒå¹¶è¡Œæ‰§è¡Œæ¨¡å¼ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹é€‰é¡¹ï¼š

```bash
# ä½¿ç”¨å¹¶è¡Œæ¨¡å¼æ‰§è¡Œæµ‹è¯•
python run_tests.py --parallel

# æŒ‡å®šå·¥ä½œè¿›ç¨‹æ•°é‡ï¼ˆé»˜è®¤ä¸º CPU æ ¸å¿ƒæ•°ï¼‰
python run_tests.py --parallel --workers 4

# ä¸å…¶ä»–é€‰é¡¹ç»„åˆä½¿ç”¨ï¼ˆä¾‹å¦‚æ ‡è®°å’Œè¯¦ç»†è¾“å‡ºï¼‰
python run_tests.py --parallel --markers basic --verbose
```

æˆ‘ä»¬çš„å†…éƒ¨å¹¶è¡Œå®ç°æŒ‰æ–‡ä»¶åˆ’åˆ†æµ‹è¯•ï¼Œåœ¨å•ç‹¬çš„è¿›ç¨‹ä¸­è¿è¡Œæ¯ä¸ªæ–‡ä»¶ï¼Œç„¶åæ”¶é›†å¹¶æ±‡æ€»ç»“æœï¼Œæä¾›æ¸…æ™°çš„æµ‹è¯•æ‰§è¡Œæ‘˜è¦ã€‚è¿™ç§æ–¹æ³•æœ€é€‚åˆæˆ‘ä»¬çš„ CMake æµ‹è¯•éœ€æ±‚ï¼Œä½¿æµ‹è¯•è¿‡ç¨‹ç®€å•è€Œé«˜æ•ˆã€‚

### ğŸ·ï¸ æµ‹è¯•æ ‡è®°ç³»ç»Ÿ

ä¸ºä¾¿äºç»„ç»‡å’Œé€‰æ‹©æ€§æ‰§è¡Œæµ‹è¯•ï¼ŒGitVersion.cmake é¡¹ç›®å®šä¹‰äº†ä»¥ä¸‹æµ‹è¯•æ ‡è®°ï¼š

- `basic`: æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•ï¼ŒéªŒè¯åŸºæœ¬ç‰ˆæœ¬æå–å’Œè§£æåŠŸèƒ½
- `advanced`: é«˜çº§åŠŸèƒ½æµ‹è¯•ï¼Œè¦†ç›–å¤æ‚åœºæ™¯å’Œé…ç½®é€‰é¡¹
- `edge_cases`: è¾¹ç¼˜æƒ…å†µæµ‹è¯•ï¼Œç¡®ä¿åœ¨ç‰¹æ®Šå’Œå¼‚å¸¸æƒ…å†µä¸‹ç³»ç»Ÿè¡Œä¸ºç¬¦åˆé¢„æœŸ

è¿™äº›æ ‡è®°åœ¨ `pyproject.toml` æ–‡ä»¶ä¸­å®šä¹‰ï¼Œå¹¶é€šè¿‡ pytest çš„æ ‡è®°ç³»ç»Ÿå®ç°æµ‹è¯•åˆ†ç±»ä¸ç­›é€‰ã€‚

## âœï¸ æ·»åŠ æ–°æµ‹è¯•

éšç€é¡¹ç›®åŠŸèƒ½çš„æ‰©å±•ï¼Œæ‚¨å¯èƒ½éœ€è¦æ·»åŠ æ–°çš„æµ‹è¯•ç”¨ä¾‹ã€‚è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

1. åœ¨é€‚å½“çš„æµ‹è¯•ç›®å½•ä¸‹åˆ›å»ºæ–°çš„æµ‹è¯•æ–‡ä»¶ï¼ˆæ–‡ä»¶ååº”ä»¥ `_test.py` ç»“å°¾ï¼Œè¡¨ç¤ºå…¶æµ‹è¯•æ–‡ä»¶èº«ä»½ï¼‰
2. å¯¼å…¥å¿…è¦çš„æ¨¡å—ã€å·¥å…·ç±»å’Œæµ‹è¯•æ¡†æ¶ç»„ä»¶
3. ä½¿ç”¨é€‚å½“çš„ pytest marker è£…é¥°å™¨ï¼ˆå¦‚ `@pytest.mark.basic`ï¼‰æ ‡è®°æµ‹è¯•ç±»å‹
4. å®ç°æµ‹è¯•å‡½æ•°ï¼ˆå»ºè®®ä½¿ç”¨ `test_` å‰ç¼€å‘½åï¼Œæé«˜å¯å‘ç°æ€§ï¼‰

### ğŸ“ æµ‹è¯•æ–‡ä»¶æ¨¡æ¿

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå…¸å‹æµ‹è¯•æ–‡ä»¶çš„ç»“æ„ç¤ºä¾‹ï¼š

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Tests for [Feature Name] in GitVersion.cmake.

This test module verifies [Specific Functionality] behavior under [Specific Scenario].
"""

import pytest
import os
from pathlib import Path

# Use pytest marker to mark test type
@pytest.mark.basic  # or advanced, edge_cases, etc.
def test_my_feature(git_env, cmake_project, gitversion_cmake_path):
    """
    Test whether [Feature] correctly [Expected Behavior] under [Conditions].
    
    Test steps:
    1. Set up test environment
    2. Perform test operations
    3. Verify results match expectations
    """
    # Set up test environment
    git_env.create_file("README.md", "# Test Project")
    git_env.commit("Initial commit")
    git_env.tag("1.2.3")  # Create version tag
    
    # Configure CMake project
    cmake_project.create_cmakelists({
        "DEFAULT_VERSION": "1.2.3",
        "PREFIX": "v"
    })
    
    # Perform test operations
    version_info = cmake_project.configure()
    
    # Verify test results
    assert version_info.get("PROJECT_VERSION") == "1.2.3", f"Version should be 1.2.3, actual: {version_info.get('PROJECT_VERSION')}"
    assert version_info.get("MAJOR_MACRO") == "1", "Major version doesn't match"
    assert version_info.get("MINOR_MACRO") == "2", "Minor version doesn't match"
    assert version_info.get("PATCH_MACRO") == "3", "Patch version doesn't match"
```

## ğŸ’¯ æµ‹è¯•æœ€ä½³å®è·µ

éµå¾ªä»¥ä¸‹æœ€ä½³å®è·µå¯ä»¥æé«˜æµ‹è¯•è´¨é‡å’Œå¯ç»´æŠ¤æ€§ï¼š

1. **æµ‹è¯•å¤¹å…·ä½¿ç”¨**: å……åˆ†åˆ©ç”¨ `conftest.py` ä¸­å®šä¹‰çš„ fixtures (`git_env`, `cmake_project` ç­‰)ï¼Œå‡å°‘é‡å¤ä»£ç å¹¶ç¡®ä¿æµ‹è¯•ç¯å¢ƒä¸€è‡´æ€§

2. **åˆ†ç±»ä¸æ ‡è®°**: ä½¿ç”¨é€‚å½“çš„ pytest markers å¯¹æµ‹è¯•è¿›è¡Œåˆ†ç±»ï¼Œä¾¿äºæœ‰é€‰æ‹©æ€§åœ°è¿è¡Œç›¸å…³æµ‹è¯•ç»„

3. **æµ‹è¯•éš”ç¦»**: ç¡®ä¿æ¯ä¸ªæµ‹è¯•å‡½æ•°æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼Œä¸ä¾èµ–äºå…¶ä»–æµ‹è¯•çš„æ‰§è¡Œç»“æœæˆ–çŠ¶æ€

4. **æ˜ç¡®çš„æ–­è¨€æ¶ˆæ¯**: ä¸ºæ¯ä¸ªæ–­è¨€æä¾›æ¸…æ™°è¯¦ç»†çš„å¤±è´¥æ¶ˆæ¯ï¼Œä½¿è°ƒè¯•è¿‡ç¨‹æ›´é«˜æ•ˆ

5. **å‚æ•°åŒ–æµ‹è¯•**: ä½¿ç”¨ `@pytest.mark.parametrize` è£…é¥°å™¨æµ‹è¯•å¤šç§è¾“å…¥ç»„åˆï¼Œæé«˜æµ‹è¯•è¦†ç›–ç‡

6. **è¯¦ç»†æ–‡æ¡£**: ä¸ºæ¯ä¸ªæµ‹è¯•å‡½æ•°ç¼–å†™æ¸…æ™°çš„æ–‡æ¡£å­—ç¬¦ä¸²ï¼Œè¯´æ˜æµ‹è¯•ç›®çš„ã€æ­¥éª¤å’Œé¢„æœŸç»“æœ

7. **æµ‹è¯•ç²’åº¦**: æ¯ä¸ªæµ‹è¯•å‡½æ•°åº”ä¸“æ³¨äºéªŒè¯ä¸€ä¸ªç‰¹å®šåŠŸèƒ½ç‚¹ï¼Œé¿å…è¿‡äºå¤æ‚çš„æµ‹è¯•é€»è¾‘

8. **è¾¹ç¼˜æƒ…å†µ**: ä¸ä»…æµ‹è¯•æ­£å¸¸è·¯å¾„ï¼Œè¿˜åº”è€ƒè™‘å¼‚å¸¸æƒ…å†µã€é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæ¡ä»¶
